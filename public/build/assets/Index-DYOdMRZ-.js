import{r as s,e as K,f as P,d as v,j as e}from"./vendor-core-CVn978f7.js";import{u as V,M as $}from"./Map-BuP_MAO0.js";import{B as b}from"./button--cW8-JAs.js";import{C as w,a as E}from"./card-CIre8WR5.js";import{L as z}from"./label-CLYoN36p.js";import{S as q}from"./switch-D4iXip2W.js";import{m as T,o as G}from"./firebase-B2pyU7xz.js";import{u as J}from"./use-Geolocation-DZfnMrFf.js";import{M as Y}from"./main-layout-D8k80jl2.js";import{O as H}from"./index-BU_B9Ap-.js";import{y as f}from"./index-CZyFl0Li.js";import{ac as Q,ad as W,g as X,ae as Z,u as ee}from"./vendor-icons-BvP0H4xj.js";import"./app-CQrnIAdu.js";import"./app-DQJAPa6p.js";import"./vendor-ui-CpttHis2.js";import"./utils-szUE-hBx.js";import"./CartFloatButton-BQZCgCMY.js";import"./drawer-cart-DypxYsUP.js";import"./ProviderLayout-Adcfx3ho.js";function se({follow:r,zoom:u=16,animate:p=!0,duration:d=.6,enabled:m=!0}={}){const a=V();return s.useEffect(()=>{!m||!r||a.flyTo(r,u,{animate:p,duration:d})},[r,u,p,d,m,a]),{map:a,flyTo:(n,c=u)=>{a.flyTo(n,c,{animate:p,duration:d})},setView:(n,c=u)=>{a.setView(n,c)}}}const g=20,te="/sounds/notification.mp3",re="/sounds/blocked.mp3",ae=.6,k=(...r)=>r.filter(Boolean).join(" ");function ie({position:r}){return se({follow:r}),null}function ke({activeOrder:r}){const{auth:u}=K().props,{user:p}=u,{latitude:d,longitude:m}=J(),a=!!(p?.delivery_profile?.status?.is_available??!1),n=!!r,c=s.useRef(a),C=s.useRef(n);s.useEffect(()=>{c.current=a},[a]),s.useEffect(()=>{C.current=n},[n]);const[_,L]=s.useState([0,0]),[l,A]=s.useState(null),[M,j]=s.useState(g),[h,R]=s.useState(!1),x=s.useRef(null),N=s.useRef(null),S=s.useRef(null);s.useEffect(()=>{S.current=l},[l]),s.useEffect(()=>{if(!(typeof window>"u"))return x.current=new Audio(te),N.current=new Audio(re),N.current.volume=ae,()=>{x.current=null,N.current=null}},[]);const B=s.useCallback(()=>typeof document>"u"?"":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"",[]),o=s.useCallback(i=>{x.current?.pause(),x.current&&(x.current.currentTime=0),A(null),j(g),i&&f.info(i)},[]),U=s.useCallback(async i=>{if(!h){R(!0);try{await P.post(`/delivery/orders/${i}/accept`,{},{headers:{"Content-Type":"application/json"},withCredentials:!0}),f.success("Pedido aceptado ðŸš´â€â™‚ï¸"),o(),v.reload({only:["activeOrder"]})}catch(t){if(o(),P.isAxiosError(t)){const y=t.response?.data?.message??"Error inesperado";f.error(y)}}finally{R(!1)}}},[o,B,h]),O=s.useCallback((i,t)=>{v.post(i,{},{onSuccess:()=>{f.success(t),v.reload({only:["activeOrder"]})},onError:y=>f.error(y?.message??"Error")})},[]),I=s.useCallback(()=>{N.current?.play().catch(()=>{})},[]),D=s.useCallback(()=>{if(C.current){I();return}v.patch("/delivery/availability",{status:!c.current})},[I]);return s.useEffect(()=>{d&&m&&L([d,m])},[d,m]),s.useEffect(()=>{let i;return l&&(j(g),i=window.setInterval(()=>{j(t=>t<=1?(o("Pedido rechazado por tiempo"),g):t-1)},1e3)),()=>{i&&window.clearInterval(i)}},[l,o]),s.useEffect(()=>{if(!T)return;const i=G(T,t=>{if(!c.current)return;if(f.success(e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("p",{className:"font-bold",children:t.data?.title??"Nuevo Pedido"}),t.data?.body&&e.jsx("p",{className:"text-xs",children:t.data.body})]})),t.data?.order_status===H.READY_FOR_PICKUP&&!S.current&&!C.current&&c.current){const F={id:Number(t.data?.order_id),delivery_fee:t.data?.delivery_fee,store_name:t.data?.store_name,distance:t.data?.distance};if(!Number(t.data?.order_id))return;A(F),j(g),x.current?.play().catch(()=>{})}});return()=>{typeof i=="function"&&i()}},[]),s.useEffect(()=>{n&&l&&o()},[n,l,o]),e.jsx(Y,{children:e.jsxs("div",{className:"min-h-screen space-y-2 bg-purple-50/50 p-2",children:[l&&e.jsx("div",{className:"fixed inset-x-0 bottom-0 z-50 duration-300 animate-in slide-in-from-bottom",children:e.jsx(w,{className:"rounded-t-2xl border-t border-purple-200 bg-white shadow-2xl",children:e.jsxs(E,{className:"space-y-3 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-xs font-bold tracking-widest text-purple-600 uppercase",children:"Pedido listo"}),e.jsxs("div",{className:"flex items-center gap-1 rounded-full bg-red-100 px-2 py-0.5 text-[10px] font-bold text-red-600",children:[e.jsx(Q,{className:"h-3 w-3"}),e.jsxs("span",{children:[M,"s"]})]})]}),e.jsxs("span",{className:"text-xs font-semibold text-gray-400",children:["#",l.id]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:l.store_name??"Nuevo comercio"}),e.jsxs("p",{className:"text-[11px] text-gray-500",children:["Distancia:"," ",l.distance??"â€”"," km"]})]}),e.jsxs("div",{className:"flex items-center gap-1 font-bold text-green-600",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("span",{children:l.delivery_fee})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{variant:"outline",className:"flex-1",onClick:()=>o("Pedido rechazado"),disabled:h,"aria-label":"Rechazar pedido",children:"Rechazar"}),e.jsx(b,{className:"flex-1 bg-purple-600 font-bold",onClick:()=>U(l.id),disabled:h,"aria-label":"Aceptar pedido",children:h?"Procesando...":"Aceptar pedido"})]})]})})}),n&&e.jsx(w,{className:"border-purple-200 bg-white",children:e.jsxs(E,{className:"space-y-2 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 text-purple-600"}),e.jsx("p",{className:"text-sm font-semibold text-purple-900",children:"Pedido en curso"})]}),e.jsxs("span",{className:"text-[10px] font-bold text-purple-500",children:["#",r.id]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{className:"flex-1 bg-purple-600 text-xs","aria-label":"Marcar llegada",children:"LleguÃ©"}),r.status==="picked_up"&&e.jsx(b,{className:"flex-1 bg-green-600 text-xs",onClick:()=>O(`/delivery/orders/${r.id}/on-the-way`,"En camino ðŸš´â€â™‚ï¸"),"aria-label":"Iniciar ruta",children:"Iniciar Ruta"}),r.status==="on_the_way"&&e.jsx(b,{className:"flex-1 bg-blue-600 text-xs",onClick:()=>O(`/delivery/orders/${r.id}/delivered`,"Entregado ðŸ“¦"),"aria-label":"Entregar pedido",children:"Entregar"})]})]})}),e.jsx(w,{className:k("overflow-hidden border-purple-200 py-1",!a&&"bg-gray-200"),children:e.jsxs(E,{className:"flex items-center justify-between p-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Z,{className:"h-8 w-8 text-purple-700"}),e.jsx("div",{className:k("absolute -right-0.5 -bottom-0.5 h-3 w-3 rounded-full border-2 border-white",a?"bg-green-500":"bg-gray-400")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm leading-tight font-semibold text-purple-900",children:p.name}),e.jsx("p",{className:"text-[10px] font-semibold text-gray-500 uppercase",children:"Repartidor"})]})]}),e.jsxs("div",{className:k("flex items-center gap-2 rounded-lg border border-purple-100 bg-purple-50 px-2 py-1.5",n&&"opacity-50"),children:[e.jsx(z,{htmlFor:"disponibilidad",className:"text-[10px] font-bold text-purple-800 uppercase",children:a?"En lÃ­nea":"Desconectado"}),e.jsx("div",{onClick:()=>D(),role:"button",children:e.jsx(q,{id:"disponibilidad",checked:a,disabled:n,onCheckedChange:()=>D(),className:"data-[state=checked]:bg-purple-600"})})]})]})}),a?e.jsx(w,{className:"relative h-80 overflow-hidden border-purple-200 bg-white p-0 shadow-sm",children:e.jsx($,{center:_,children:e.jsx(ie,{position:_})})}):e.jsxs("div",{className:"flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-purple-100 bg-purple-50/30 py-12",children:[e.jsx("div",{className:"mb-4 rounded-lg bg-white p-4 shadow-sm",children:e.jsx(ee,{className:"h-10 w-10 text-gray-300"})}),e.jsx("h2",{className:"text-sm font-semibold text-gray-700 uppercase",children:"No puedes recibir pedidos"}),e.jsx("p",{className:"mt-1 text-[10px] tracking-widest text-gray-500 uppercase",children:"Activa tu disponibilidad"})]})]})})}export{ke as default};
