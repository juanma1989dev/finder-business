import{r,j as t,d as y,f as q}from"./vendor-core-CVn978f7.js";import{m as C,o as H}from"./firebase-B2pyU7xz.js";import{D as J}from"./dashboard-layout-DBIvlQ1a.js";import{O as l}from"./index-BU_B9Ap-.js";import{y as b}from"./index-CZyFl0Li.js";import U from"./GridOrders-BdVY2g2_.js";import V from"./NotesDialog-Baj2MTwx.js";import w from"./Stat-C6SwDTAV.js";import{v as W,w as K,x as Q}from"./vendor-icons-BvP0H4xj.js";import"./vendor-ui-CpttHis2.js";import"./button--cW8-JAs.js";import"./utils-szUE-hBx.js";import"./dropdown-menu-BbU8JRam.js";import"./index-CN9EY2cw.js";import"./index-CVASjcgI.js";import"./ProviderLayout-Adcfx3ho.js";import"./useOrderStatus-BkAjmRv2.js";import"./OrderCard-qsACGQ0R.js";var O=(n=>(n.Todos="Todos",n.Pendiente="Pendiente",n.Confirmado="Confirmado",n.Entregado="Entregado",n))(O||{});const X=[l.CANCELLED,l.REJECTED];function ge({breadcrumbs:n,orders:D,business:u,final_statuses:I}){const[x,v]=r.useState(!!u?.is_open),P=I,[d,T]=r.useState("Todos"),[p,L]=r.useState(""),[k,j]=r.useState(null),[m,R]=r.useState(D),[i,f]=r.useState({open:!1}),[c,g]=r.useState(""),E=r.useRef(null),[A,B]=r.useState(null);r.useEffect(()=>{const e=s=>{s.key==="Escape"&&(f({open:!1}),g("")),s.key==="Enter"&&i.open&&c.trim()&&h(i.orderId,i.status,c)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[i,c]),r.useEffect(()=>{if(C)return H(C,e=>{b.success(t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("p",{className:"font-bold",children:e.data?.title||"Nuevo Pedido"}),t.jsx("p",{className:"text-xs",children:e.data?.body})]})),E.current&&clearTimeout(E.current),S()})},[]);const F=()=>{const e=x;v(!e),y.patch(`/dashboard/business/${u.id}-${u.slug}/opening-hours`,{id:u.id,status:!e},{onError:()=>{v(e),b.error("No se pudo actualizar el negocio")}})},G=(e,s)=>{if(s&&X.includes(s)){f({open:!0,orderId:e,status:s});return}h(e,s)},h=(e,s,a)=>{j(e),y.patch(`/dashboard/orders/${e}/status`,{status:s,note:a},{preserveScroll:!0,onSuccess:()=>{f({open:!1}),g(""),S()},onError:()=>b.error("Error al actualizar pedido"),onFinish:()=>j(null)})},N=r.useMemo(()=>m.filter(e=>{if(p){const s=p.toLowerCase();if(!e.id.toString().includes(s)&&!e.user?.name?.toLowerCase().includes(s))return!1}return d==="Pendiente"?e.status===l.PENDING:d==="Confirmado"?e.status===l.CONFIRMED:d==="Entregado"?e.status===l.DELIVERED:!0}),[m,p,d]),$=(e,s)=>{const a=new Map;return e.forEach(o=>{a.set(o.id,o)}),s.forEach(o=>{P.includes(o.status)?a.delete(o.id):a.set(o.id,o)}),Array.from(a.values())},S=async()=>{try{const s=(await q.get("/dashboard/orders/delta",{params:{since:A},withCredentials:!0})).data?.orders??[];if(s.length){const a=s.map(o=>new Date(o.updated_at).getTime()).sort((o,z)=>z-o)[0];B(new Date(a).toISOString())}R(a=>$(a,s))}catch(e){console.error("Error :: ",e)}},M=m.filter(e=>e.status===l.PENDING).length,_=m.filter(e=>e.status===l.PENDING).length;return t.jsxs(J,{breadcrumbs:n,children:[t.jsxs("div",{className:"flex min-h-screen flex-col gap-3 bg-purple-50/30 p-2 sm:p-2 lg:p-4",children:[t.jsxs("div",{className:"sticky top-14 z-40 rounded-lg border border-purple-200 bg-white p-2 shadow-sm sm:static",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-base font-semibold tracking-tight text-purple-800 uppercase",children:"Pedidos"}),t.jsx("p",{className:"text-[10px] font-normal tracking-widest text-gray-500 uppercase",children:"Gestión de tus pedidos."})]}),t.jsx("button",{onClick:F,className:`flex cursor-pointer items-center gap-2 rounded-lg px-4 py-2 text-[10px] font-semibold uppercase transition-all active:scale-95 ${x?"bg-purple-600 text-white shadow-sm":"border border-amber-200 bg-amber-50 text-amber-700"}`,children:x?t.jsxs(t.Fragment,{children:["Abierto ",t.jsx(W,{className:"h-3.5 w-3.5"})]}):t.jsxs(t.Fragment,{children:["Cerrado ",t.jsx(K,{className:"h-3.5 w-3.5"})]})})]}),t.jsxs("div",{className:"mt-3 grid grid-cols-3 gap-2",children:[t.jsx(w,{label:"Pendientes",value:M}),t.jsx(w,{label:"Retrasados",value:_,danger:!0}),t.jsx(w,{label:"Filtrados",value:N.length})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(Q,{className:"absolute top-1/2 left-3 h-4 w-4 -translate-y-1/2 text-gray-400"}),t.jsx("input",{className:"w-full rounded-lg border border-purple-200 bg-white py-3 pr-4 pl-10 text-sm font-normal text-gray-700 shadow-sm transition-all focus:border-purple-600 focus:ring-1 focus:ring-purple-600 focus:outline-none",placeholder:"Buscar pedido o cliente…",value:p,onChange:e=>L(e.target.value)})]}),t.jsx("div",{className:"scrollbar-hide flex gap-2 overflow-x-auto pb-1",children:Object.values(O).map(e=>t.jsx("button",{onClick:()=>T(e),className:`rounded-lg px-4 py-2 text-[10px] font-semibold whitespace-nowrap uppercase transition-all active:scale-95 ${d===e?"bg-purple-600 text-white shadow-sm":"border border-purple-100 bg-white text-gray-500 hover:bg-purple-50"}`,children:e},e))}),t.jsx("div",{className:"relative min-h-[400px]",children:t.jsx(U,{orders:N,loadingOrderId:k,onChangeStatus:G})})]}),t.jsx(V,{open:i.open,value:c,onChange:g,onClose:()=>f({open:!1,orderId:null,status:void 0}),onConfirm:()=>h(i.orderId,i.status,c)})]})}export{ge as default};
